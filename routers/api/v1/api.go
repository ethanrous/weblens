// Package v1 provides the version 1 API routes and handlers for the Weblens application.
package v1

import (
	"net/http"
	"time"

	_ "github.com/ethanrous/weblens/docs" // docs is generated by Swag CLI, you have to import it.
	backup_api "github.com/ethanrous/weblens/routers/api/v1/backup"
	file_api "github.com/ethanrous/weblens/routers/api/v1/file"
	history_api "github.com/ethanrous/weblens/routers/api/v1/history"
	media_api "github.com/ethanrous/weblens/routers/api/v1/media"
	tower_api "github.com/ethanrous/weblens/routers/api/v1/tower"
	user_api "github.com/ethanrous/weblens/routers/api/v1/user"
	"github.com/ethanrous/weblens/routers/api/v1/websocket"
	"github.com/ethanrous/weblens/routers/router"
	context_service "github.com/ethanrous/weblens/services/ctxservice"
	"github.com/go-chi/chi/v5/middleware"

	httpSwagger "github.com/swaggo/http-swagger/v2"
)

// Routes creates and configures the version 1 API router with all route handlers and middleware.
func Routes(_ context_service.AppContext) *router.Router {
	r := router.NewRouter()

	r.Use(
		router.WeblensAuth,
		router.ShareInjector,
	)

	r.Get("/info", tower_api.GetServerInfo)
	r.Get("/ws", websocket.Connect)

	// Media
	r.Group("/media", func() {
		r.Get("/types", media_api.GetMediaTypes)

		r.Group("/{mediaID}", func() {
			r.Get("/info", media_api.GetMediaInfo)
			r.Get(".{extension}", media_api.GetMediaImage)
			r.Get("/stream", media_api.StreamVideo)
			r.Get("/{chunkName}", media_api.StreamVideo)
			r.Patch("/liked", router.RequireSignIn, media_api.SetMediaLiked)
		})

		r.Group("", func() {
			r.Get("/{mediaID}/file", media_api.GetMediaFile)
			r.Post("/cleanup", media_api.CleanupMedia)
			r.Post("/drop", router.RequireOwner, media_api.DropMedia)
			r.Post("/drop/hdirs", router.RequireOwner, media_api.DropHDIRs)
			r.Patch("/visibility", media_api.HideMedia)
			r.Patch("/date", media_api.AdjustMediaDate)
		}, router.RequireSignIn)

		// POST because it needs body for all the params.
		// Kinda hacky, but its better than GET with a body or with 100 query params.
		// Also, this can take a while, so we set a long timeout.
		r.Post("", middleware.Timeout(time.Minute*10), media_api.GetMediaBatch)

		r.Get("/random", media_api.GetRandomMedia)
	})

	// Files
	r.Group("/files", func() {
		r.Patch("", file_api.MoveFiles)
		r.Delete("", file_api.DeleteFiles)
		r.Get("/search", file_api.SearchByFilename)
		r.Get("/autocomplete", file_api.AutocompletePath)
		r.Patch("/untrash", file_api.UnTrashFiles)
		r.Post("/restore", file_api.RestoreFiles)
		r.Get("/shared", file_api.GetSharedFiles)

		r.Group("/{fileID}", func() {
			r.Get("", file_api.GetFile)
			r.Patch("", file_api.UpdateFile)
			r.Get("/text", file_api.GetFileText)
			r.Get("/stats", file_api.GetFileStats)
			r.Get("/download", file_api.DownloadFile)
			r.Get("/history", file_api.GetFolderHistory)
		})
	})

	// Folder
	r.Group("/folder", func() {
		r.Group("/{folderID}", func() {
			r.Get("", file_api.GetFolder)
			r.Post("/scan", file_api.ScanDir)
			r.Patch("/cover", router.RequireSignIn, file_api.SetFolderCover)
		})

		r.Post("", router.RequireSignIn, file_api.CreateFolder)
	})

	// Journal
	// r.Get("/journal", getLifetimesSince)

	// Upload
	r.Group("/upload", func() {
		r.Post("", file_api.NewUploadTask)
		r.Group("/{uploadID}", func() {
			r.Get("", file_api.GetUploadResult)
			r.Post("", file_api.NewFileUpload)
			r.Put("/file/{fileID}", file_api.HandleUploadChunk)
		})
	}, router.RequireSignIn, router.RequireCoreTower)

	// Takeout
	r.Post("/takeout", file_api.CreateTakeout)

	// Users
	r.Group("/users", func() {
		// Must not use weblens auth here, as the user is not logged in yet
		r.Post("/auth", user_api.Login)
		r.Head("/{username}", user_api.CheckExists)

		r.Group("", func() {
			r.Get("", user_api.GetAll)
			r.Post("", user_api.Create)
			r.Get("/me", user_api.GetMe)
			r.Get("/search", user_api.Search)
			r.Post("/logout", user_api.Logout)

			r.Group("/{username}", func() {
				r.Patch("/password", user_api.UpdatePassword)
				r.Patch("/admin", user_api.SetAdmin)
				r.Patch("/active", user_api.Activate)
				r.Patch("/fullName", user_api.ChangeDisplayName)
				r.Delete("", user_api.Delete)
			})
		}, router.RequireSignIn)
	})

	// Share
	r.Group("/share", func() {
		r.Post("/file", file_api.CreateFileShare)
		r.Group("/{shareID}", func() {
			r.Get("", file_api.GetFileShare)
			r.Patch("/public", router.RequireSignIn, file_api.SetSharePublic)
			r.Delete("", router.RequireSignIn, file_api.DeleteShare)

			r.Group("/accessors", func() {
				r.Post("", file_api.AddUserToShare)
				r.Patch("/{username}", file_api.SetShareAccessors)
				r.Delete("/{username}", file_api.RemoveUserFromShare)
			})
		})
	})

	// ApiKeys
	r.Group("/keys", func() {
		r.Get("", user_api.GetMyTokens)
		r.Post("", user_api.CreateAPIKey)
		r.Delete("/{tokenID}", user_api.DeleteToken)
	}, router.RequireSignIn, router.RequireCoreTower)

	// Servers
	r.Group("/tower", func() {
		r.Post("/init", tower_api.InitializeTower)
		r.Get("/history", history_api.GetPagedHistoryActions)
		r.Group("", func() {
			r.Get("/tasks", tower_api.GetRunningTasks)

			r.Post("/reset", router.RequireOwner, tower_api.ResetServer)
			r.Post("/remote", tower_api.AttachRemote)
			r.Get("", tower_api.GetRemotes)

			r.Get("/backup", history_api.DoFullBackup)

			r.Post("/{serverID}/backup", backup_api.LaunchBackup)

			r.Post("/trace", tower_api.EnableTraceLogging)
			r.Delete("/{serverID}", tower_api.DeleteRemote)

			r.Delete("/cache", tower_api.FlushCache)
		}, router.RequireAdmin)
	})

	r.Group("/flags", func() {
		r.Get("", tower_api.GetFlags)
		r.Post("", tower_api.SetFlags)
	}, router.RequireAdmin)

	return r
}

// Docs returns an HTTP handler that serves the Swagger API documentation.
func Docs() http.Handler {
	// Kinda hacky, but allows for docs to be served from /docs/ instead of /docs/index.html
	return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
		if req.RequestURI == "/docs/" {
			req.RequestURI = "/docs/index.html"
		}

		httpSwagger.WrapHandler(w, req)
	})
}
